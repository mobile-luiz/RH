<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RH PRO - Sistema Integrado v5.4</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    :root { 
      --primary: #2563eb; 
      --sidebar-bg: #111827; 
      --bg: #f3f4f6; 
      --card: #ffffff; 
      --text: #111827; 
      --border: #e5e7eb; 
      --success: #16a34a; 
      --danger: #dc2626; 
      --warning: #f59e0b; 
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: var(--bg); display: flex; min-height: 100vh; }
    
    /* SIDEBAR */
    .sidebar { width: 260px; background: var(--sidebar-bg); color: white; position: fixed; height: 100vh; display: flex; flex-direction: column; z-index: 100; overflow-y: auto; }
    .sidebar-header { padding: 30px 20px; border-bottom: 1px solid #374151; display: flex; align-items: center; gap: 10px; }
    .nav-item { padding: 12px 20px; display: flex; align-items: center; gap: 12px; cursor: pointer; color: #d1d5db; transition: 0.2s; border-left: 4px solid transparent; }
    .nav-item:hover, .nav-item.active { background: #1f2937; color: white; border-left-color: var(--primary); }
    .menu-group { padding: 20px 20px 5px; font-size: 11px; text-transform: uppercase; color: #6b7280; letter-spacing: 1px; font-weight: bold; }
    
    /* MAIN */
    .main { margin-left: 260px; flex: 1; padding: 40px; width: calc(100% - 260px); }
    .tab-content { display: none; animation: fadeIn 0.3s ease; }
    .tab-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    .card { background: var(--card); border-radius: 12px; padding: 25px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid var(--border); margin-bottom: 20px; }
    
    /* DASHBOARD & GRIDS */
    .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
    .stat-card { background: white; padding: 20px; border-radius: 10px; border-left: 4px solid var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .stat-card h4 { font-size: 11px; color: #64748b; text-transform: uppercase; margin-bottom: 5px; font-weight: 700; }
    .stat-card h2 { font-size: 24px; color: var(--text); font-weight: 700; margin: 0; }
    .dash-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
    .chart-container { position: relative; height: 300px; width: 100%; }
    
    /* TABLES & BADGES */
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th { text-align: left; padding: 12px; background: #f8fafc; font-size: 11px; text-transform: uppercase; color: #64748b; border-bottom: 2px solid var(--border); }
    td { padding: 12px; border-bottom: 1px solid var(--border); font-size: 13px; }
    .badge { padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; }
    .bg-meta { background: #dcfce7; color: #166534; }
    .bg-fora { background: #fee2e2; color: #b91c1c; }
    .bg-adv { background: #fef3c7; color: #92400e; }
    
    /* FORMS & PHOTO */
    .photo-section { border: 2px dashed var(--border); border-radius: 12px; padding: 20px; text-align: center; background: #fafafa; margin-bottom: 20px; }
    .preview-circle { width: 130px; height: 130px; border-radius: 50%; object-fit: cover; border: 4px solid var(--primary); display: none; margin: 0 auto 15px; }
    video { width: 100%; max-width: 300px; border-radius: 8px; background: #000; margin-bottom: 10px; display: none; margin: 0 auto; }
    .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
    .full { grid-column: span 2; }
    .field { display: flex; flex-direction: column; gap: 6px; }
    label { font-size: 12px; font-weight: 700; color: #4b5563; text-transform: uppercase; }
    input, select, textarea { padding: 10px; border: 1px solid var(--border); border-radius: 6px; outline: none; font-size: 14px; background: #fff; }
    .btn-submit { background: var(--primary); color: white; border: none; padding: 15px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 15px; transition: 0.2s; }
    .btn-submit:hover { background: #1d4ed8; }
    .btn-secondary { background: #e2e8f0; color: #475569; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px; margin: 5px; font-weight: 600; }
    
    /* LOADER */
    #loader { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:2000; justify-content:center; align-items:center; flex-direction:column; }
    
    /* MODAL EDITAR */
    .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:3000; justify-content:center; align-items:center; }
    .modal-content { background:white; padding:30px; border-radius:12px; width:90%; max-width:500px; }
  </style>
</head>
<body>

  <!-- LOADER -->
  <div id="loader">
    <div style="text-align:center">
      <i class="fas fa-circle-notch fa-spin fa-3x" style="color:var(--primary)"></i>
      <p style="margin-top:15px; font-weight:500;">Processando...</p>
    </div>
  </div>

  <!-- MODAL EDITAR -->
  <div id="modal-editar" class="modal">
    <div class="modal-content">
      <h2 style="margin-bottom:20px;">Editar Colaborador</h2>
      <div class="form-grid">
        <div class="field full"><label>Nome</label><input type="text" id="edit-nome"></div>
        <div class="field"><label>Matrícula</label><input type="text" id="edit-mat" readonly></div>
        <div class="field"><label>Setor</label><input type="text" id="edit-setor"></div>
        <div class="field"><label>Função</label><input type="text" id="edit-funcao"></div>
        <div class="field"><label>Data Admissão</label><input type="date" id="edit-adm"></div>
        <div class="field"><label>Status</label><select id="edit-status"><option>Ativo</option><option>Inativo</option></select></div>
        <div class="field full"><label>URL da Foto</label><input type="text" id="edit-foto" placeholder="Cole URL da imagem"></div>
      </div>
      <div style="display:flex; gap:10px; margin-top:20px;">
        <button class="btn-submit" style="flex:1" onclick="salvarEdicao()">SALVAR ALTERAÇÕES</button>
        <button class="btn-secondary" onclick="fecharModal()">CANCELAR</button>
      </div>
    </div>
  </div>

  <!-- SIDEBAR -->
  <nav class="sidebar">
    <div class="sidebar-header">
      <i class="fas fa-chart-line fa-lg"></i> 
      <h2>RH PRO</h2>
    </div>
    
    <div class="menu-group">OPERACIONAL</div>
    <div class="nav-item active" onclick="switchTab('cadastro', this)">
      <i class="fas fa-user-plus"></i> Cadastro Base
    </div>
    <div class="nav-item" onclick="switchTab('ocorrencia', this)">
      <i class="fas fa-exclamation-circle"></i> Lançar Ocorrência
    </div>
    <div class="nav-item" onclick="switchTab('colaboradores-lista', this); carregarTodosColaboradores();">
      <i class="fas fa-users"></i> Todos Colaboradores
    </div>
    
    <div class="menu-group">RELATÓRIOS</div>
    <div class="nav-item" onclick="switchTab('relatorio', this)">
      <i class="fas fa-calendar-day"></i> Relatório Diário
    </div>
    <div class="nav-item" onclick="switchTab('mensal', this)">
      <i class="fas fa-chart-bar"></i> Relatório Mensal
    </div>
    <div class="nav-item" onclick="switchTab('anual', this)">
      <i class="fas fa-trophy"></i> Relatório Anual
    </div>
    <div class="nav-item" onclick="switchTab('dashboard', this); carregarDashboard();" style="color: var(--warning); font-weight:bold;">
      <i class="fas fa-tachometer-alt"></i> Dashboard Executivo
    </div>
    
    <div class="menu-group">CONSULTAS</div>
    <div class="nav-item" onclick="switchTab('consulta', this); carregarTabelas();">
      <i class="fas fa-list-ul"></i> Histórico Geral
    </div>
    <div class="nav-item" onclick="switchTab('ficha', this)">
      <i class="fas fa-id-card"></i> Ficha Técnica
    </div>
  </nav>

  <!-- MAIN CONTENT -->
  <main class="main">
    
    <!-- CADASTRO DE COLABORADOR -->
    <section id="tab-cadastro" class="tab-content active">
      <div class="card">
        <h2>Cadastro de Colaborador</h2>
        <div class="photo-section">
          <img id="img-preview" class="preview-circle">
          <video id="webcam" autoplay></video>
          <canvas id="canvas" width="320" height="240" style="display:none"></canvas>
          <div style="margin-top:15px;">
            <button class="btn-secondary" onclick="startCam()">
              <i class="fas fa-camera"></i> Câmera
            </button>
            <button class="btn-secondary" id="snap" style="display:none; background:var(--success); color:white" onclick="capture()">
              Capturar Foto
            </button>
            <label class="btn-secondary">
              <i class="fas fa-upload"></i> Subir Arquivo 
              <input type="file" hidden accept="image/*" onchange="previewFile(this)">
            </label>
          </div>
          <input type="hidden" id="c-foto">
        </div>
        <div class="form-grid">
          <div class="field full"><label>Nome Completo</label><input type="text" id="c-nome" required></div>
          <div class="field"><label>Matrícula</label><input type="text" id="c-mat" required></div>
          <div class="field"><label>Setor</label><input type="text" id="c-setor" required></div>
          <div class="field"><label>Função</label><input type="text" id="c-funcao" required></div>
          <div class="field"><label>Data Admissão</label><input type="date" id="c-adm" required></div>
          <div class="field"><label>Status</label>
            <select id="c-status">
              <option>Ativo</option>
              <option>Inativo</option>
            </select>
          </div>
        </div>
        <button class="btn-submit" onclick="saveColab()">CADASTRAR</button>
      </div>
    </section>

    <!-- DASHBOARD -->
    <section id="tab-dashboard" class="tab-content">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
          <h2>Dashboard Executivo</h2>
          <div style="display:flex; gap:10px;">
            <input type="month" id="dash-periodo" onchange="carregarDashboard()">
            <button class="btn-submit" style="margin:0; width:auto;" onclick="carregarDashboard()">
              <i class="fas fa-sync-alt"></i> Atualizar
            </button>
          </div>
        </div>
        <div class="stats-grid">
          <div class="stat-card"><h4>Indicador Geral (Mês)</h4><h2 id="d-ind-geral">0.00%</h2></div>
          <div class="stat-card"><h4>Meta x Realizado</h4><h2 id="d-meta-status" style="font-size:16px;">--</h2><small style="color:#64748b">Meta: 1.92%</small></div>
          <div class="stat-card"><h4>Total de Medidas</h4><h2 id="d-total-medidas">0</h2></div>
          <div class="stat-card" style="border-left-color: var(--warning);"><h4>Setor Crítico</h4><h2 id="d-setor-critico" style="font-size:18px">--</h2></div>
        </div>
        <div class="dash-row">
          <div class="card"><h3><i class="fas fa-chart-pie"></i> Distribuição por Tipo</h3><div class="chart-container"><canvas id="chartTipo"></canvas></div></div>
          <div class="card"><h3><i class="fas fa-chart-line"></i> Tendência Anual</h3><div class="chart-container"><canvas id="chartTendencia"></canvas></div></div>
        </div>
        <div class="dash-row">
          <div class="card"><h3><i class="fas fa-building"></i> Faltas por Setor</h3><div class="chart-container"><canvas id="chartSetor"></canvas></div></div>
          <div class="card"><h3><i class="fas fa-users"></i> Top 5 Faltosos</h3>
            <table id="tab-top5">
              <thead><tr><th>Nome</th><th>Setor</th><th>Faltas</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- OCORRÊNCIAS -->
    <section id="tab-ocorrencia" class="tab-content">
      <div class="card">
        <h2>Lançamento de Ocorrência</h2>
        <div class="form-grid">
          <div class="field"><label>Categoria</label>
            <select id="o-cat" onchange="toggleForm()">
              <option value="Falta">Falta</option>
              <option value="Disciplinar">Medida Disciplinar</option>
            </select>
          </div>
          <div class="field"><label>Matrícula</label><input type="text" id="o-mat" required></div>
          <div class="field"><label>Data</label><input type="date" id="o-data" required></div>
          <div class="field"><label id="label-tipo">Tipo</label><select id="o-tipo"></select></div>
          <div class="field full" id="box-dias" style="display:none"><label>Dias de Suspensão</label><input type="number" id="o-dias" value="0"></div>
          <div class="field full"><label>Motivo / Observação</label><textarea id="o-obs" rows="3"></textarea></div>
        </div>
        <button class="btn-submit" onclick="salvarOcorrenciaGeral()">SALVAR REGISTRO</button>
      </div>
    </section>

    <!-- RELATÓRIO DIÁRIO -->
    <section id="tab-relatorio" class="tab-content">
      <div class="card">
        <h2>Relatório Diário</h2>
        <div class="form-grid" style="grid-template-columns: repeat(4, 1fr); align-items:end;">
          <div class="field"><label>Data</label><input type="date" id="filtro-data" required></div>
          <div class="field"><label>Setor</label><input type="text" id="filtro-setor"></div>
          <div class="field"><label>Colaborador</label><input type="text" id="filtro-colab"></div>
          <button class="btn-submit" style="margin:0; padding:10px" onclick="gerarRelatorioDiario()">FILTRAR</button>
        </div>
        <table>
          <thead>
            <tr><th>Nome</th><th>Matrícula</th><th>Setor</th><th>Tipo</th><th>Obs</th></tr>
          </thead>
          <tbody id="corpoRelatorio"></tbody>
        </table>
      </div>
    </section>

    <!-- RELATÓRIO MENSAL -->
    <section id="tab-mensal" class="tab-content">
      <div class="card">
        <h2>Relatório Mensal</h2>
        <div style="display:flex; gap:10px; margin-bottom:20px;">
          <input type="month" id="m-periodo" required>
          <button class="btn-submit" style="margin:0; width:auto;" onclick="gerarRelatorioMensal()">PROCESSAR</button>
        </div>
        <div class="stats-grid">
          <div class="stat-card"><h4>Atestados</h4><h2 id="st-atestado">0</h2></div>
          <div class="stat-card"><h4>Declarações</h4><h2 id="st-declaracao">0</h2></div>
          <div class="stat-card"><h4>Faltas Injust.</h4><h2 id="st-falta">0</h2></div>
          <div class="stat-card"><h4>% Geral</h4><h2 id="st-perc">0%</h2></div>
        </div>
        <div style="overflow-x:auto;">
          <table>
            <thead>
              <tr><th>Nome</th><th>Setor</th><th>Atest</th><th>Decl</th><th>Falta</th><th>% Indiv</th><th>Meta (1.92%)</th></tr>
            </thead>
            <tbody id="corpoMensal"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- RELATÓRIO ANUAL -->
    <section id="tab-anual" class="tab-content">
      <div class="card">
        <h2>Análise Anual</h2>
        <div style="display:flex; gap:10px; margin-bottom:20px;">
          <input type="number" id="a-ano" value="2024" min="2000" max="2100">
          <button class="btn-submit" style="margin:0; width:auto;" onclick="gerarRelatorioAnual()">GERAR ANÁLISE</button>
        </div>
        <div class="stats-grid">
          <div class="stat-card"><h4>Total Faltas</h4><h2 id="an-total-faltas">0</h2></div>
          <div class="stat-card"><h4>Setor Crítico</h4><h2 id="an-setor-critico">--</h2></div>
          <div class="stat-card"><h4>Medidas</h4><h2 id="an-total-medidas">0</h2></div>
          <div class="stat-card"><h4>Acima da Meta</h4><h2 id="an-total-fora" style="color:var(--danger)">0</h2></div>
        </div>
        <div class="dash-row">
          <div class="card"><h3>Ranking Faltas</h3>
            <table id="rankColabs">
              <thead><tr><th>Nome</th><th>Total</th><th>%</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="card"><h3>Por Setor</h3>
            <table id="rankSetores">
              <thead><tr><th>Setor</th><th>Abs%</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- CONSULTAS -->
    <section id="tab-consulta" class="tab-content">
      <div class="card">
        <h2>Medidas Disciplinares</h2>
        <table>
          <thead>
            <tr><th>Data</th><th>Mat</th><th>Tipo</th><th>Motivo</th><th>Dias</th></tr>
          </thead>
          <tbody id="corpoMedidas"></tbody>
        </table>
      </div>
      <div class="card">
        <h2>Histórico de Faltas</h2>
        <table>
          <thead>
            <tr><th>Data</th><th>Mat</th><th>Tipo</th><th>Obs</th></tr>
          </thead>
          <tbody id="corpoFaltas"></tbody>
        </table>
      </div>
    </section>

    <!-- FICHA TÉCNICA -->
    <section id="tab-ficha" class="tab-content">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 20px;">
          <div style="display:flex; align-items:center; gap:15px;">
            <h2 style="margin:0;">Ficha Técnica Individual</h2>
            <div id="acoes-ficha" style="display:none; gap:10px;">
              <button class="btn-secondary" onclick="exportarPDF()" style="background:#dc2626; color:white; margin:0; border:none; display:flex; align-items:center; gap:8px;">
                <i class="fas fa-file-pdf"></i> SALVAR PDF
              </button>
            </div>
          </div>
          <div style="display:flex; gap:5px;">
            <input type="text" id="busca-mat" placeholder="Digite a matrícula..." style="width:150px;">
            <button class="btn-submit" style="margin:0; width:auto; padding:10px 15px;" onclick="gerarFicha()">
              <i class="fas fa-search"></i> BUSCAR
            </button>
          </div>
        </div>
        <div id="ficha-container" style="display:none; background: white; padding: 10px;">
          <div style="display:grid; grid-template-columns: 180px 1fr 220px; gap:25px; align-items: start;">
            <div style="text-align:center">
              <img id="f-foto" src="https://via.placeholder.com/150" style="width:150px; height:150px; border-radius:15px; border:3px solid #f3f4f6; object-fit:cover; margin-bottom:10px;">
              <div style="font-size: 11px; color: #666; text-transform: uppercase; font-weight: bold; margin-bottom: 4px;">Tempo de Empresa</div>
              <div id="f-tempo" class="badge bg-adv" style="display:block; padding:8px; font-size:12px; white-space: normal;">--</div>
            </div>
            <div style="display: flex; flex-direction: column; gap: 12px;">
              <div><label style="color:#64748b; font-size:11px;">NOME COMPLETO</label><h3 id="f-nome" style="font-size:20px; color:var(--sidebar-bg);">--</h3></div>
              <div><label style="color:#64748b; font-size:11px;">SETOR / FUNÇÃO</label><p id="f-cargo" style="font-weight:500;">--</p></div>
              <div><label style="color:#64748b; font-size:11px;">DATA DE ADMISSÃO</label><p id="f-adm">--</p></div>
            </div>
            <div style="text-align:center; background:#f8fafc; padding:20px; border-radius:12px; border: 1px solid #e2e8f0;">
              <label style="color:#64748b; font-size:11px; font-weight: bold;">ABSENTEÍSMO (MÊS)</label>
              <h2 id="f-abs" style="font-size:32px; margin:10px 0; color:var(--primary);">0%</h2>
              <div id="f-meta-status"></div>
            </div>
          </div>
          <div class="dash-row" style="margin-top:30px;">
            <div class="card" style="margin:0; padding:15px;">
              <h3 style="font-size:14px; margin-bottom:15px;"><i class="fas fa-chart-line" style="margin-right:8px;"></i>Evolução de Faltas (Ano Atual)</h3>
              <div style="height:220px; position:relative;"><canvas id="chartFicha"></canvas></div>
            </div>
            <div class="card" style="margin:0; padding:15px;">
              <h3 style="font-size:14px; margin-bottom:15px;"><i class="fas fa-history" style="margin-right:8px;"></i>Resumo Histórico</h3>
              <div id="f-total-faltas" style="padding: 10px; background: #fff5f5; border-radius: 8px; margin-bottom: 12px; font-size: 13px;"></div>
              <div id="f-total-medidas" style="padding: 10px; background: #f8fafc; border-radius: 8px; font-size: 13px;"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- LISTA DE COLABORADORES -->
    <section id="tab-colaboradores-lista" class="tab-content">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
          <h2>Lista Geral de Colaboradores</h2>
          <button class="btn-submit" onclick="carregarTodosColaboradores()" style="margin:0; width:auto;">
            <i class="fas fa-sync"></i> Atualizar
          </button>
        </div>
        <div style="overflow-x:auto;">
          <table id="tabela-todos-colab">
            <thead>
              <tr><th>Foto</th><th>Matrícula</th><th>Nome</th><th>Setor</th><th>Função</th><th>Status</th><th>Ações</th></tr>
            </thead>
            <tbody id="corpo-todos-colab"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <script>
// ================================
// CONFIGURAÇÕES GERAIS
// ================================
const API_URL = "https://script.google.com/macros/s/AKfycbzNOtdTXoPvRrUsQPaXWGZTMwyYa-4B804RZO2m1thob8OFDCKg_whXcLYqZrSfT0KaYQ/exec";
let stream;
let charts = {};

// ================================
// FUNÇÃO DE REQUEST API
// ================================
async function api(action, data = {}) {
    try {
        const resposta = await fetch(API_URL, {
            method: "POST",
            body: JSON.stringify({ action, ...data })
        });
        return await resposta.json();
    } catch (e) {
        console.error("ERRO API:", e);
        alert("Erro de conexão. Verifique se o Script foi publicado como 'Qualquer pessoa'.");
        return { error: e.toString() };
    }
}

// ================================
// LOADER
// ================================
function showLoad(state) {
    document.getElementById('loader').style.display = state ? 'flex' : 'none';
}

// ================================
// NAVEGAÇÃO ENTRE ABAS
// ================================
function switchTab(id, el) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById('tab-' + id).classList.add('active');
    el.classList.add('active');
    if(id === 'ocorrencia') toggleForm();
}

// ================================
// FORMULÁRIO DINÂMICO DE OCORRÊNCIA
// ================================
function toggleForm() {
    const cat = document.getElementById('o-cat').value;
    const box = document.getElementById('box-dias');
    const tipo = document.getElementById('o-tipo');
    if(cat === 'Falta') {
        box.style.display = 'none';
        tipo.innerHTML = `
            <option>Justificada – Atestado</option>
            <option>Justificada – Declaração</option>
            <option>Não Justificada</option>
        `;
    } else {
        box.style.display = 'block';
        tipo.innerHTML = `
            <option>Advertência</option>
            <option>Suspensão</option>
        `;
    }
}

// ================================
// FUNÇÕES DE CÂMERA E FOTO
// ================================
async function startCam() {
    const v = document.getElementById('webcam');
    v.style.display = 'block';
    document.getElementById('img-preview').style.display = 'none';
    try {
        stream = await navigator.mediaDevices.getUserMedia({ video: true });
        v.srcObject = stream;
        document.getElementById('snap').style.display = 'inline-block';
    } catch (e) {
        alert("Erro ao acessar câmera: " + e.message);
    }
}

function capture() {
    const c = document.getElementById('canvas');
    c.getContext('2d').drawImage(document.getElementById('webcam'), 0,0,320,240);
    const b64 = c.toDataURL('image/png');
    document.getElementById('img-preview').src = b64;
    document.getElementById('img-preview').style.display = 'block';
    document.getElementById('c-foto').value = b64;
    document.getElementById('webcam').style.display = 'none';
    if(stream) stream.getTracks().forEach(t => t.stop());
}

function previewFile(input) {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        document.getElementById('img-preview').src = e.target.result;
        document.getElementById('img-preview').style.display = 'block';
        document.getElementById('c-foto').value = e.target.result;
    };
    reader.readAsDataURL(file);
}

// ================================
// CADASTRO DE COLABORADOR
// ================================
async function saveColab() {
    const nome = document.getElementById('c-nome').value;
    const mat = document.getElementById('c-mat').value;
    if(!nome || !mat) return alert("Nome e Matrícula são obrigatórios!");
    
    showLoad(true);
    const dados = {
        foto: document.getElementById('c-foto').value || "",
        nome: nome,
        mat: mat,
        setor: document.getElementById('c-setor').value,
        funcao: document.getElementById('c-funcao').value,
        adm: document.getElementById('c-adm').value,
        status: document.getElementById('c-status').value
    };
    
    const r = await api("cadastrarColaborador", { dados });
    showLoad(false);
    
    if(r?.ok) {
        alert("Colaborador cadastrado com sucesso!");
        // Limpar campos
        document.getElementById('c-nome').value = "";
        document.getElementById('c-mat').value = "";
        document.getElementById('c-setor').value = "";
        document.getElementById('c-funcao').value = "";
        document.getElementById('c-adm').value = "";
        document.getElementById('c-foto').value = "";
        document.getElementById('img-preview').style.display = 'none';
        document.getElementById('img-preview').src = "";
        const fileInput = document.querySelector('input[type="file"]');
        if(fileInput) fileInput.value = "";
    } else {
        alert("Erro ao cadastrar: " + (r?.error || "Erro desconhecido"));
    }
}

// ================================
// SALVAR OCORRÊNCIA
// ================================
async function salvarOcorrenciaGeral() {
    const mat = document.getElementById('o-mat').value;
    const dataOcorr = document.getElementById('o-data').value;
    if(!mat || !dataOcorr) return alert("Matrícula e Data são obrigatórios!");
    
    const dados = {
        cat: document.getElementById('o-cat').value,
        matricula: mat,
        data: dataOcorr,
        tipo: document.getElementById('o-tipo').value,
        dias: document.getElementById('o-dias').value || 0,
        obs: document.getElementById('o-obs').value
    };
    
    showLoad(true);
    const r = await api("salvarOcorrencia", { dados });
    showLoad(false);
    
    if(r?.ok) {
        alert("Registro salvo com sucesso!");
        // Limpar campos
        document.getElementById('o-mat').value = "";
        document.getElementById('o-data').value = "";
        document.getElementById('o-obs').value = "";
        document.getElementById('o-dias').value = "0";
        document.getElementById('o-cat').selectedIndex = 0;
        toggleForm();
    } else {
        alert("Erro ao salvar: " + (r?.error || "Erro desconhecido"));
    }
}

// ================================
// GERENCIAMENTO DE COLABORADORES
// ================================
async function carregarTodosColaboradores() {
    showLoad(true);
    const lista = await api("listarColaboradores");
    showLoad(false);
    
    const corpo = document.getElementById('corpo-todos-colab');
    corpo.innerHTML = "";
    
    if (!lista || lista.length === 0) {
        corpo.innerHTML = '<tr><td colspan="7" style="text-align:center">Nenhum colaborador cadastrado.</td></tr>';
        return;
    }
    
    lista.forEach(c => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><img src="${c.foto || 'https://via.placeholder.com/40'}" style="width:35px; height:35px; border-radius:50%; object-fit:cover;"></td>
            <td><strong>${c.mat}</strong></td>
            <td>${c.nome}</td>
            <td>${c.setor}</td>
            <td>${c.funcao}</td>
            <td><span class="badge ${c.status === 'Ativo' ? 'bg-meta' : 'bg-fora'}">${c.status}</span></td>
            <td>
                <button class="btn-secondary" title="Editar" onclick='abrirEdicao(${JSON.stringify(c)})'>
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn-secondary" title="Excluir" style="color:var(--danger)" onclick="excluirColab('${c.mat}')">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        corpo.appendChild(tr);
    });
}

function abrirEdicao(colab) {
    document.getElementById('edit-nome').value = colab.nome || "";
    document.getElementById('edit-mat').value = colab.mat || "";
    document.getElementById('edit-setor').value = colab.setor || "";
    document.getElementById('edit-funcao').value = colab.funcao || "";
    document.getElementById('edit-adm').value = colab.adm ? colab.adm.split('T')[0] : "";
    document.getElementById('edit-status').value = colab.status || "Ativo";
    document.getElementById('edit-foto').value = colab.foto || "";
    document.getElementById('modal-editar').style.display = 'flex';
}

function fecharModal() {
    document.getElementById('modal-editar').style.display = 'none';
}

async function salvarEdicao() {
    const dados = {
        matricula: document.getElementById('edit-mat').value,
        nome: document.getElementById('edit-nome').value,
        setor: document.getElementById('edit-setor').value,
        funcao: document.getElementById('edit-funcao').value,
        adm: document.getElementById('edit-adm').value,
        status: document.getElementById('edit-status').value,
        foto: document.getElementById('edit-foto').value
    };
    
    showLoad(true);
    const r = await api("editarColaborador", { dados });
    showLoad(false);
    
    if(r?.ok) {
        alert("Colaborador atualizado com sucesso!");
        fecharModal();
        carregarTodosColaboradores();
    } else {
        alert("Erro ao atualizar: " + (r?.error || "Erro desconhecido"));
    }
}

async function excluirColab(mat) {
    if (!confirm(`Deseja realmente excluir o colaborador de matrícula ${mat}?`)) return;
    
    showLoad(true);
    const r = await api("excluirColaborador", { matricula: mat });
    showLoad(false);
    
    if (r?.ok) {
        alert("Colaborador excluído com sucesso!");
        carregarTodosColaboradores();
    } else {
        alert("Erro ao excluir: " + (r?.error || "Erro desconhecido"));
    }
}

// ================================
// FUNÇÕES DE GRÁFICOS
// ================================
function renderChart(id, type, labels, data, colors) {
    const canvas = document.getElementById(id);
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    
    if (charts[id]) charts[id].destroy();
    
    charts[id] = new Chart(ctx, {
        type: type,
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: colors,
                borderColor: type === 'line' ? colors : 'transparent',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: type === 'doughnut', position: 'bottom' } },
            scales: type !== 'doughnut' ? { y: { beginAtZero: true, ticks: { stepSize: 1 } } } : {}
        }
    });
}

function renderChartComplex(id, labels, datasets) {
    const canvas = document.getElementById(id);
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    
    if (charts[id]) charts[id].destroy();
    
    charts[id] = new Chart(ctx, {
        type: 'line',
        data: { labels: labels, datasets: datasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: true, position: 'bottom' } },
            scales: { y: { beginAtZero: true } }
        }
    });
}

// ================================
// DASHBOARD EXECUTIVO
// ================================
async function carregarDashboard() {
    showLoad(true);
    let campoMes = document.getElementById('dash-periodo').value || new Date().toISOString().slice(0,7);
    document.getElementById('dash-periodo').value = campoMes;
    
    const r = await api("dashboard", { periodo: campoMes });
    showLoad(false);
    
    if(!r) return;
    
    // Atualizar KPIs
    document.getElementById('d-ind-geral').innerText = (r.kpi?.geral || 0).toFixed(2) + "%";
    document.getElementById('d-meta-status').innerHTML = r.kpi?.metaStatus || "--";
    document.getElementById('d-total-medidas').innerText = r.kpi?.totalMedidas || 0;
    document.getElementById('d-setor-critico').innerText = r.kpi?.setorCritico || "--";
    
    // Atualizar Top 5
    const corpoTop5 = document.querySelector('#tab-top5 tbody');
    corpoTop5.innerHTML = "";
    if (r.top5 && r.top5.length > 0) {
        r.top5.forEach(t => {
            corpoTop5.innerHTML += `
                <tr>
                    <td>${t.nome}</td>
                    <td>${t.setor}</td>
                    <td style="color:var(--danger); font-weight:bold;">${t.qtd}</td>
                </tr>`;
        });
    } else {
        corpoTop5.innerHTML = '<tr><td colspan="3" style="text-align:center">Nenhuma falta no período.</td></tr>';
    }
    
    // Renderizar gráficos
    if (r.graficos) {
        renderChart("chartTipo", "doughnut", 
            r.graficos.tipo?.labels || [], 
            r.graficos.tipo?.values || [], 
            ["#3b82f6","#f59e0b","#ef4444"]);
        
        renderChart("chartSetor", "bar", 
            r.graficos.setor?.labels || [], 
            r.graficos.setor?.values || [], 
            "#6366f1");
        
        // Gráfico de tendência
        if (r.graficos.tendencia) {
            renderChart("chartTendencia", "line", 
                r.graficos.tendencia.labels || ["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"], 
                r.graficos.tendencia.values || [], 
                "#2563eb");
        }
    }
}

// ================================
// RELATÓRIO DIÁRIO
// ================================
async function gerarRelatorioDiario() {
    const dataFiltro = document.getElementById('filtro-data').value;
    if (!dataFiltro) return alert("Selecione uma data!");
    
    showLoad(true);
    const filtros = {
        data: dataFiltro,
        setor: document.getElementById('filtro-setor').value,
        colab: document.getElementById('filtro-colab').value
    };
    
    const r = await api("relatorioDiario", filtros);
    showLoad(false);
    
    const corpo = document.getElementById('corpoRelatorio');
    corpo.innerHTML = "";
    
    if (r && r.length > 0) {
        r.forEach(x => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${x.nome}</td>
                <td>${x.matricula}</td>
                <td>${x.setor}</td>
                <td><span class="badge bg-fora">${x.tipo}</span></td>
                <td>${x.obs}</td>
            `;
            corpo.appendChild(tr);
        });
    } else {
        corpo.innerHTML = '<tr><td colspan="5" style="text-align:center">Nenhum registro encontrado.</td></tr>';
    }
}

// ================================
// RELATÓRIO MENSAL
// ================================
async function gerarRelatorioMensal() {
    const periodo = document.getElementById('m-periodo').value;
    if(!periodo) return alert("Selecione o período!");
    
    showLoad(true);
    const r = await api("relatorioMensal", { periodo: periodo });
    showLoad(false);
    
    document.getElementById('st-atestado').innerText = r?.totais?.atestados || 0;
    document.getElementById('st-declaracao').innerText = r?.totais?.declaracoes || 0;
    document.getElementById('st-falta').innerText = r?.totais?.faltas || 0;
    document.getElementById('st-perc').innerText = (r?.totais?.percentualGeral || 0).toFixed(2) + "%";
    
    const corpo = document.getElementById('corpoMensal');
    corpo.innerHTML = "";
    
    if (r?.linhas && r.linhas.length > 0) {
        r.linhas.forEach(x => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${x.nome}</td>
                <td>${x.setor}</td>
                <td>${x.atestados}</td>
                <td>${x.declaracoes}</td>
                <td>${x.faltas}</td>
                <td>${x.percentual?.toFixed(2) || "0.00"}%</td>
                <td><span class="badge ${(x.percentual || 0) <= 1.92 ? 'bg-meta' : 'bg-fora'}">${(x.percentual || 0) <= 1.92 ? 'OK' : 'FORA'}</span></td>
            `;
            corpo.appendChild(tr);
        });
    } else {
        corpo.innerHTML = '<tr><td colspan="7" style="text-align:center">Nenhum dado encontrado.</td></tr>';
    }
}

// ================================
// RELATÓRIO ANUAL
// ================================
async function gerarRelatorioAnual() {
    const ano = document.getElementById('a-ano').value;
    if(!ano) return alert("Informe o ano!");
    
    showLoad(true);
    const r = await api("relatorioAnual", { ano: ano });
    showLoad(false);
    
    if (!r) return;
    
    document.getElementById('an-total-faltas').innerText = r.resumo?.totalFaltas || 0;
    document.getElementById('an-setor-critico').innerText = r.resumo?.setorCritico || "--";
    document.getElementById('an-total-medidas').innerText = r.resumo?.totalMedidas || 0;
    document.getElementById('an-total-fora').innerText = r.resumo?.qtdAcimaMeta || 0;
    
    // Ranking Colaboradores
    const corpoColabs = document.querySelector('#rankColabs tbody');
    corpoColabs.innerHTML = "";
    if (r.rankingColabs && r.rankingColabs.length > 0) {
        r.rankingColabs.forEach(c => {
            corpoColabs.innerHTML += `
                <tr>
                    <td>${c.nome}</td>
                    <td>${c.total}</td>
                    <td>${c.perc}%</td>
                </tr>`;
        });
    } else {
        corpoColabs.innerHTML = '<tr><td colspan="3" style="text-align:center">Nenhum dado</td></tr>';
    }
    
    // Ranking Setores
    const corpoSetores = document.querySelector('#rankSetores tbody');
    corpoSetores.innerHTML = "";
    if (r.rankingSetores && r.rankingSetores.length > 0) {
        r.rankingSetores.forEach(s => {
            corpoSetores.innerHTML += `
                <tr>
                    <td>${s.nome}</td>
                    <td>${s.abs}%</td>
                </tr>`;
        });
    } else {
        corpoSetores.innerHTML = '<tr><td colspan="2" style="text-align:center">Nenhum dado</td></tr>';
    }
}

// ================================
// CONSULTAS GERAIS
// ================================
async function carregarTabelas() {
    showLoad(true);
    const r = await api("consultaGeral");
    showLoad(false);
    
    const faltas = document.getElementById('corpoFaltas');
    const medidas = document.getElementById('corpoMedidas');
    faltas.innerHTML = "";
    medidas.innerHTML = "";
    
    if (!r || r.length === 0) return;
    
    r.forEach(item => {
        let dataFormatada = item.data;
        if (dataFormatada && typeof dataFormatada === 'string' && dataFormatada.includes('-')) {
            dataFormatada = dataFormatada.split('T')[0].split('-').reverse().join('/');
        }
        
        const tr = document.createElement('tr');
        if (item.cat === "Falta") {
            tr.innerHTML = `
                <td>${dataFormatada}</td>
                <td>${item.matricula}</td>
                <td><span class="badge bg-fora">${item.tipo}</span></td>
                <td>${item.obs || "-"}</td>
            `;
            faltas.appendChild(tr);
        } else {
            tr.innerHTML = `
                <td>${dataFormatada}</td>
                <td>${item.matricula}</td>
                <td><span class="badge bg-adv">${item.tipo}</span></td>
                <td>${item.obs || "-"}</td>
                <td>${item.dias || "0"}</td>
            `;
            medidas.appendChild(tr);
        }
    });
}

// ================================
// FICHA TÉCNICA
// ================================
async function gerarFicha() {
    const mat = document.getElementById('busca-mat').value;
    if(!mat) return alert("Digite uma matrícula!");
    
    showLoad(true);
    const r = await api("ficha", { matricula: mat });
    showLoad(false);
    
    if(!r || !r.colaborador) {
        alert("Colaborador não encontrado.");
        return;
    }
    
    document.getElementById('ficha-container').style.display = 'block';
    document.getElementById('acoes-ficha').style.display = 'flex';
    
    // Dados básicos
    document.getElementById('f-foto').src = r.colaborador.foto || "https://via.placeholder.com/150";
    document.getElementById('f-nome').innerText = r.colaborador.nome;
    document.getElementById('f-cargo').innerText = `${r.colaborador.setor} / ${r.colaborador.funcao}`;
    
    // Tempo de empresa
    if (r.colaborador.adm) {
        const adm = new Date(r.colaborador.adm);
        const hoje = new Date();
        let anos = hoje.getFullYear() - adm.getFullYear();
        let meses = hoje.getMonth() - adm.getMonth();
        if (meses < 0) { anos--; meses += 12; }
        let texto = anos > 0 ? `${anos} ano${anos > 1 ? 's' : ''}` : '';
        texto += meses > 0 ? ` e ${meses} mês${meses > 1 ? 'es' : ''}` : '';
        document.getElementById('f-tempo').innerText = texto || "Admitido este mês";
    } else {
        document.getElementById('f-tempo').innerText = "--";
    }
    
    // Data admissão formatada
    let dAdm = r.colaborador.adm;
    if (dAdm && typeof dAdm === 'string' && dAdm.includes('-')) {
        dAdm = dAdm.split('T')[0].split('-').reverse().join('/');
    }
    document.getElementById('f-adm').innerText = dAdm || "--";
    
    // Absenteísmo
    document.getElementById('f-abs').innerText = (r.absenteismo || 0).toFixed(2) + "%";
    const metaStatus = (r.absenteismo || 0) <= 1.92 ? 
        '<span class="badge bg-meta">DENTRO DA META</span>' : 
        '<span class="badge bg-fora">FORA DA META</span>';
    document.getElementById('f-meta-status').innerHTML = metaStatus;
    
    // Histórico
    document.getElementById('f-total-faltas').innerHTML = `<strong>Total de Faltas:</strong> ${r.totalFaltas || 0}`;
    
    const medidasHtml = r.medidas && r.medidas.length > 0 ? 
        "<strong>Medidas Disciplinares:</strong><br>" + r.medidas.map(m => {
            let dataM = m.data;
            if (dataM && typeof dataM === 'string' && dataM.includes('-')) {
                dataM = dataM.split('T')[0].split('-').reverse().join('/');
            }
            return `<small>• ${dataM} — ${m.tipo} (${m.obs || 'S/O'})</small>`;
        }).join("<br>") : 
        "<strong>Medidas Disciplinares:</strong> Nenhuma registrada.";
    document.getElementById('f-total-medidas').innerHTML = medidasHtml;
    
    // Gráfico
    const ctx = document.getElementById('chartFicha').getContext('2d');
    if (charts['chartFicha']) charts['chartFicha'].destroy();
    
    if (r.graficoEvolucao && r.graficoEvolucao.values) {
        charts['chartFicha'] = new Chart(ctx, {
            type: 'line',
            data: {
                labels: r.graficoEvolucao.labels || ["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"],
                datasets: [{
                    label: 'Faltas',
                    data: r.graficoEvolucao.values,
                    borderColor: '#2563eb',
                    backgroundColor: 'rgba(37, 99, 235, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true } }
            }
        });
    }
}

// ================================
// EXPORTAR PDF
// ================================
function exportarPDF() {
    const elemento = document.getElementById('ficha-container');
    const nome = document.getElementById('f-nome').innerText || "ficha";
    const opt = {
        margin: 10,
        filename: `Ficha_${nome}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };
    html2pdf().set(opt).from(elemento).save();
}

// ================================
// INICIALIZAÇÃO
// ================================
document.addEventListener('DOMContentLoaded', function() {
    // Definir data atual nos campos
    const hoje = new Date().toISOString().split('T')[0];
    document.getElementById('o-data').value = hoje;
    document.getElementById('filtro-data').value = hoje;
    document.getElementById('c-adm').value = hoje;
    document.getElementById('dash-periodo').value = hoje.slice(0,7);
    document.getElementById('m-periodo').value = hoje.slice(0,7);
    
    // Inicializar formulário de ocorrência
    toggleForm();
});
  </script>
</body>
</html>